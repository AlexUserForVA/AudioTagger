
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>madmom.audio.spectrogram &#8212; Audio Tagger 1.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Audio Tagger 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for madmom.audio.spectrogram</h1><div class="highlight"><pre>
<span></span><span class="c1"># encoding: utf-8</span>
<span class="c1"># pylint: disable=no-member</span>
<span class="c1"># pylint: disable=invalid-name</span>
<span class="c1"># pylint: disable=too-many-arguments</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains spectrogram related functionality.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">..processors</span> <span class="k">import</span> <span class="n">Processor</span><span class="p">,</span> <span class="n">SequentialProcessor</span><span class="p">,</span> <span class="n">BufferProcessor</span>
<span class="kn">from</span> <span class="nn">.filters</span> <span class="k">import</span> <span class="p">(</span><span class="n">Filterbank</span><span class="p">,</span> <span class="n">LogarithmicFilterbank</span><span class="p">,</span> <span class="n">NUM_BANDS</span><span class="p">,</span> <span class="n">FMIN</span><span class="p">,</span> <span class="n">FMAX</span><span class="p">,</span>
                      <span class="n">A4</span><span class="p">,</span> <span class="n">NORM_FILTERS</span><span class="p">,</span> <span class="n">UNIQUE_FILTERS</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">spec</span><span class="p">(</span><span class="n">stft</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the magnitudes of the complex Short Time Fourier Transform of a</span>
<span class="sd">    signal.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stft : numpy array</span>
<span class="sd">        Complex STFT of a signal.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spec : numpy array</span>
<span class="sd">        Magnitude spectrogram.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stft</span><span class="p">)</span>


<span class="c1"># magnitude spectrogram of STFT</span>
<span class="k">class</span> <span class="nc">Spectrogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`Spectrogram` represents the magnitude spectrogram of a</span>
<span class="sd">    :class:`.audio.stft.ShortTimeFourierTransform`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stft : :class:`.audio.stft.ShortTimeFourierTransform` instance</span>
<span class="sd">        Short Time Fourier Transform.</span>
<span class="sd">    kwargs : dict, optional</span>
<span class="sd">        If no :class:`.audio.stft.ShortTimeFourierTransform` instance was</span>
<span class="sd">        given, one is instantiated with these additional keyword arguments.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Create a :class:`Spectrogram` from a</span>
<span class="sd">    :class:`.audio.stft.ShortTimeFourierTransform` (or anything it can be</span>
<span class="sd">    instantiated from:</span>

<span class="sd">    &gt;&gt;&gt; spec = Spectrogram(&#39;tests/data/audio/sample.wav&#39;)</span>
<span class="sd">    &gt;&gt;&gt; spec  # doctest: +NORMALIZE_WHITESPACE +ELLIPSIS</span>
<span class="sd">    Spectrogram([[ 3.15249,  4.00272, ...,  0.03634,  0.03671],</span>
<span class="sd">                 [ 4.28429,  2.85158, ...,  0.0219 ,  0.02227],</span>
<span class="sd">                 ...,</span>
<span class="sd">                 [ 4.92274, 10.27775, ...,  0.00607,  0.00593],</span>
<span class="sd">                 [ 9.22709,  9.6387 , ...,  0.00981,  0.00984]], dtype=float32)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=super-on-old-class</span>
    <span class="c1"># pylint: disable=super-init-not-called</span>
    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stft</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this method is for documentation purposes only</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">stft</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.stft</span> <span class="k">import</span> <span class="n">ShortTimeFourierTransform</span>
        <span class="c1"># check stft type</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stft</span><span class="p">,</span> <span class="n">Spectrogram</span><span class="p">):</span>
            <span class="c1"># already a Spectrogram</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">stft</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stft</span><span class="p">,</span> <span class="n">ShortTimeFourierTransform</span><span class="p">):</span>
            <span class="c1"># take the abs of the STFT</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stft</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># try to instantiate a ShortTimeFourierTransform</span>
            <span class="n">stft</span> <span class="o">=</span> <span class="n">ShortTimeFourierTransform</span><span class="p">(</span><span class="n">stft</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># take the abs of the STFT</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stft</span><span class="p">)</span>
        <span class="c1"># cast as Spectrogram</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># save additional attributes</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">stft</span> <span class="o">=</span> <span class="n">stft</span>
        <span class="c1"># return the object</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># set default values here, also needed for views</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stft</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;stft&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of frames.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of bins.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bin frequencies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stft</span><span class="o">.</span><span class="n">bin_frequencies</span>

    <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the difference of the magnitude spectrogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments passed to :class:`SpectrogramDifference`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        diff : :class:`SpectrogramDifference` instance</span>
<span class="sd">            The differences of the magnitude spectrogram.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SpectrogramDifference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a filtered version of the magnitude spectrogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments passed to :class:`FilteredSpectrogram`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filt_spec : :class:`FilteredSpectrogram` instance</span>
<span class="sd">            Filtered version of the magnitude spectrogram.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FilteredSpectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a logarithmically scaled version of the magnitude spectrogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments passed to :class:`LogarithmicSpectrogram`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        log_spec : :class:`LogarithmicSpectrogram` instance</span>
<span class="sd">            Logarithmically scaled version of the magnitude spectrogram.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LogarithmicSpectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SpectrogramProcessor</span><span class="p">(</span><span class="n">Processor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SpectrogramProcessor class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Spectrogram from the given data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : numpy array</span>
<span class="sd">            Data to be processed.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments passed to :class:`Spectrogram`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        spec : :class:`Spectrogram` instance</span>
<span class="sd">            Spectrogram.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Spectrogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># filtered spectrogram stuff</span>
<span class="n">FILTERBANK</span> <span class="o">=</span> <span class="n">LogarithmicFilterbank</span>


<span class="k">class</span> <span class="nc">FilteredSpectrogram</span><span class="p">(</span><span class="n">Spectrogram</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FilteredSpectrogram class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrogram : :class:`Spectrogram` instance</span>
<span class="sd">        Spectrogram.</span>
<span class="sd">    filterbank : :class:`.audio.filters.Filterbank`, optional</span>
<span class="sd">        Filterbank class or instance; if a class is given (rather than an</span>
<span class="sd">        instance), one will be created with the given type and parameters.</span>
<span class="sd">    num_bands : int, optional</span>
<span class="sd">        Number of filter bands (per octave, depending on the type of the</span>
<span class="sd">        `filterbank`).</span>
<span class="sd">    fmin : float, optional</span>
<span class="sd">        Minimum frequency of the filterbank [Hz].</span>
<span class="sd">    fmax : float, optional</span>
<span class="sd">        Maximum frequency of the filterbank [Hz].</span>
<span class="sd">    fref : float, optional</span>
<span class="sd">        Tuning frequency of the filterbank [Hz].</span>
<span class="sd">    norm_filters : bool, optional</span>
<span class="sd">        Normalize the filter bands of the filterbank to area 1.</span>
<span class="sd">    unique_filters : bool, optional</span>
<span class="sd">        Indicate if the filterbank should contain only unique filters, i.e.</span>
<span class="sd">        remove duplicate filters resulting from insufficient resolution at</span>
<span class="sd">        low frequencies.</span>
<span class="sd">    kwargs : dict, optional</span>
<span class="sd">        If no :class:`Spectrogram` instance was given, one is instantiated</span>
<span class="sd">        with these additional keyword arguments.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Create a :class:`FilteredSpectrogram` from a :class:`Spectrogram` (or</span>
<span class="sd">    anything it can be instantiated from. Per default a</span>
<span class="sd">    :class:`.madmom.audio.filters.LogarithmicFilterbank` with 12 bands per</span>
<span class="sd">    octave is used.</span>

<span class="sd">    &gt;&gt;&gt; spec = FilteredSpectrogram(&#39;tests/data/audio/sample.wav&#39;)</span>
<span class="sd">    &gt;&gt;&gt; spec  # doctest: +NORMALIZE_WHITESPACE +ELLIPSIS</span>
<span class="sd">    FilteredSpectrogram([[ 5.66156, 6.30141, ..., 0.05426, 0.06461],</span>
<span class="sd">                         [ 8.44266, 8.69582, ..., 0.07703, 0.0902 ],</span>
<span class="sd">                         ...,</span>
<span class="sd">                         [10.04626, 1.12018, ..., 0.0487 , 0.04282],</span>
<span class="sd">                         [ 8.60186, 6.81195, ..., 0.03721, 0.03371]],</span>
<span class="sd">                        dtype=float32)</span>

<span class="sd">    The resulting spectrogram has fewer frequency bins, with the centers of</span>
<span class="sd">    the bins aligned logarithmically (lower frequency bins still have a linear</span>
<span class="sd">    spacing due to the coarse resolution of the DFT at low frequencies):</span>

<span class="sd">    &gt;&gt;&gt; spec.shape</span>
<span class="sd">    (281, 81)</span>
<span class="sd">    &gt;&gt;&gt; spec.num_bins</span>
<span class="sd">    81</span>
<span class="sd">    &gt;&gt;&gt; spec.bin_frequencies  # doctest: +NORMALIZE_WHITESPACE +ELLIPSIS</span>
<span class="sd">    array([    43.06641,    64.59961,    86.13281,   107.66602,</span>
<span class="sd">              129.19922,   150.73242,   172.26562,   193.79883, ...,</span>
<span class="sd">            10551.26953, 11175.73242, 11843.26172, 12553.85742,</span>
<span class="sd">            13285.98633, 14082.71484, 14922.50977, 15805.37109])</span>

<span class="sd">    The filterbank used to filter the spectrogram is saved as an attribute:</span>

<span class="sd">    &gt;&gt;&gt; spec.filterbank  # doctest: +NORMALIZE_WHITESPACE +ELLIPSIS</span>
<span class="sd">    LogarithmicFilterbank([[0., 0., ..., 0., 0.],</span>
<span class="sd">                           [0., 0., ..., 0., 0.],</span>
<span class="sd">                           ...,</span>
<span class="sd">                           [0., 0., ..., 0., 0.],</span>
<span class="sd">                           [0., 0., ..., 0., 0.]], dtype=float32)</span>
<span class="sd">    &gt;&gt;&gt; spec.filterbank.num_bands</span>
<span class="sd">    81</span>

<span class="sd">    The filterbank can be chosen at instantiation time:</span>

<span class="sd">    &gt;&gt;&gt; from madmom.audio.filters import MelFilterbank</span>
<span class="sd">    &gt;&gt;&gt; spec = FilteredSpectrogram(&#39;tests/data/audio/sample.wav&#39;, \</span>
<span class="sd">    filterbank=MelFilterbank, num_bands=40)</span>
<span class="sd">    &gt;&gt;&gt; type(spec.filterbank)</span>
<span class="sd">    &lt;class &#39;madmom.audio.filters.MelFilterbank&#39;&gt;</span>
<span class="sd">    &gt;&gt;&gt; spec.shape</span>
<span class="sd">    (281, 40)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=super-on-old-class</span>
    <span class="c1"># pylint: disable=super-init-not-called</span>
    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="n">filterbank</span><span class="o">=</span><span class="n">FILTERBANK</span><span class="p">,</span> <span class="n">num_bands</span><span class="o">=</span><span class="n">NUM_BANDS</span><span class="p">,</span>
                 <span class="n">fmin</span><span class="o">=</span><span class="n">FMIN</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">FMAX</span><span class="p">,</span> <span class="n">fref</span><span class="o">=</span><span class="n">A4</span><span class="p">,</span> <span class="n">norm_filters</span><span class="o">=</span><span class="n">NORM_FILTERS</span><span class="p">,</span>
                 <span class="n">unique_filters</span><span class="o">=</span><span class="n">UNIQUE_FILTERS</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this method is for documentation purposes only</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="n">filterbank</span><span class="o">=</span><span class="n">FILTERBANK</span><span class="p">,</span> <span class="n">num_bands</span><span class="o">=</span><span class="n">NUM_BANDS</span><span class="p">,</span>
                <span class="n">fmin</span><span class="o">=</span><span class="n">FMIN</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">FMAX</span><span class="p">,</span> <span class="n">fref</span><span class="o">=</span><span class="n">A4</span><span class="p">,</span> <span class="n">norm_filters</span><span class="o">=</span><span class="n">NORM_FILTERS</span><span class="p">,</span>
                <span class="n">unique_filters</span><span class="o">=</span><span class="n">UNIQUE_FILTERS</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="c1"># instantiate a Spectrogram if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">Spectrogram</span><span class="p">):</span>
            <span class="c1"># try to instantiate a Spectrogram object</span>
            <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">Spectrogram</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># instantiate a Filterbank if needed</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">filterbank</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">filterbank</span><span class="p">,</span> <span class="n">Filterbank</span><span class="p">):</span>
            <span class="c1"># a Filterbank class is given, create a filterbank of this type</span>
            <span class="n">filterbank</span> <span class="o">=</span> <span class="n">filterbank</span><span class="p">(</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">bin_frequencies</span><span class="p">,</span>
                                    <span class="n">num_bands</span><span class="o">=</span><span class="n">num_bands</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span>
                                    <span class="n">fref</span><span class="o">=</span><span class="n">fref</span><span class="p">,</span> <span class="n">norm_filters</span><span class="o">=</span><span class="n">norm_filters</span><span class="p">,</span>
                                    <span class="n">unique_filters</span><span class="o">=</span><span class="n">unique_filters</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filterbank</span><span class="p">,</span> <span class="n">Filterbank</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;not a Filterbank type or instance: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="n">filterbank</span><span class="p">)</span>
        <span class="c1"># filter the spectrogram</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">filterbank</span><span class="p">)</span>
        <span class="c1"># cast as FilteredSpectrogram</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># save additional attributes</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">filterbank</span> <span class="o">=</span> <span class="n">filterbank</span>
        <span class="c1"># and those from the given spectrogram</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">stft</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="o">.</span><span class="n">stft</span>
        <span class="c1"># return the object</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># set default values here, also needed for views</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stft</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;stft&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;filterbank&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bin frequencies.&quot;&quot;&quot;</span>
        <span class="c1"># use the center frequencies of the filterbank as bin_frequencies</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span><span class="o">.</span><span class="n">center_frequencies</span>


<span class="k">class</span> <span class="nc">FilteredSpectrogramProcessor</span><span class="p">(</span><span class="n">Processor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FilteredSpectrogramProcessor class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filterbank : :class:`.audio.filters.Filterbank`</span>
<span class="sd">        Filterbank used to filter a spectrogram.</span>
<span class="sd">    num_bands : int</span>
<span class="sd">        Number of bands (per octave).</span>
<span class="sd">    fmin : float, optional</span>
<span class="sd">        Minimum frequency of the filterbank [Hz].</span>
<span class="sd">    fmax : float, optional</span>
<span class="sd">        Maximum frequency of the filterbank [Hz].</span>
<span class="sd">    fref : float, optional</span>
<span class="sd">        Tuning frequency of the filterbank [Hz].</span>
<span class="sd">    norm_filters : bool, optional</span>
<span class="sd">        Normalize the filter of the filterbank to area 1.</span>
<span class="sd">    unique_filters : bool, optional</span>
<span class="sd">        Indicate if the filterbank should contain only unique filters, i.e.</span>
<span class="sd">        remove duplicate filters resulting from insufficient resolution at</span>
<span class="sd">        low frequencies.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filterbank</span><span class="o">=</span><span class="n">FILTERBANK</span><span class="p">,</span> <span class="n">num_bands</span><span class="o">=</span><span class="n">NUM_BANDS</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="n">FMIN</span><span class="p">,</span>
                 <span class="n">fmax</span><span class="o">=</span><span class="n">FMAX</span><span class="p">,</span> <span class="n">fref</span><span class="o">=</span><span class="n">A4</span><span class="p">,</span> <span class="n">norm_filters</span><span class="o">=</span><span class="n">NORM_FILTERS</span><span class="p">,</span>
                 <span class="n">unique_filters</span><span class="o">=</span><span class="n">UNIQUE_FILTERS</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span> <span class="o">=</span> <span class="n">filterbank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">=</span> <span class="n">num_bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmin</span> <span class="o">=</span> <span class="n">fmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">fmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fref</span> <span class="o">=</span> <span class="n">fref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_filters</span> <span class="o">=</span> <span class="n">norm_filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_filters</span> <span class="o">=</span> <span class="n">unique_filters</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a FilteredSpectrogram from the given data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : numpy array</span>
<span class="sd">            Data to be processed.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments passed to :class:`FilteredSpectrogram`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filt_spec : :class:`FilteredSpectrogram` instance</span>
<span class="sd">            Filtered spectrogram.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update arguments passed to FilteredSpectrogram</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filterbank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span><span class="p">,</span> <span class="n">num_bands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">,</span>
                    <span class="n">fmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmax</span><span class="p">,</span> <span class="n">fref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fref</span><span class="p">,</span>
                    <span class="n">norm_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_filters</span><span class="p">,</span>
                    <span class="n">unique_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_filters</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># instantiate a FilteredSpectrogram and return it</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">FilteredSpectrogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># cache the filterbank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filterbank</span>
        <span class="k">return</span> <span class="n">data</span>


<span class="c1"># logarithmic spectrogram stuff</span>
<span class="n">LOG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span>
<span class="n">MUL</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">ADD</span> <span class="o">=</span> <span class="mf">1.</span>


<span class="k">class</span> <span class="nc">LogarithmicSpectrogram</span><span class="p">(</span><span class="n">Spectrogram</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LogarithmicSpectrogram class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrogram : :class:`Spectrogram` instance</span>
<span class="sd">        Spectrogram.</span>
<span class="sd">    log : numpy ufunc, optional</span>
<span class="sd">        Logarithmic scaling function to apply.</span>
<span class="sd">    mul : float, optional</span>
<span class="sd">        Multiply the magnitude spectrogram with this factor before taking</span>
<span class="sd">        the logarithm.</span>
<span class="sd">    add : float, optional</span>
<span class="sd">        Add this value before taking the logarithm of the magnitudes.</span>
<span class="sd">    kwargs : dict, optional</span>
<span class="sd">        If no :class:`Spectrogram` instance was given, one is instantiated</span>
<span class="sd">        with these additional keyword arguments.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Create a :class:`LogarithmicSpectrogram` from a :class:`Spectrogram` (or</span>
<span class="sd">    anything it can be instantiated from. Per default `np.log10` is used as</span>
<span class="sd">    the scaling function and a value of 1 is added to avoid negative values.</span>

<span class="sd">    &gt;&gt;&gt; spec = LogarithmicSpectrogram(&#39;tests/data/audio/sample.wav&#39;)</span>
<span class="sd">    &gt;&gt;&gt; spec  # doctest: +NORMALIZE_WHITESPACE +ELLIPSIS</span>
<span class="sd">    LogarithmicSpectrogram([[...]], dtype=float32)</span>
<span class="sd">    &gt;&gt;&gt; spec.min()</span>
<span class="sd">    LogarithmicSpectrogram(0., dtype=float32)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=super-on-old-class</span>
    <span class="c1"># pylint: disable=super-init-not-called</span>
    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">LOG</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="n">MUL</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">ADD</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this method is for documentation purposes only</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">LOG</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="n">MUL</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">ADD</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># instantiate a Spectrogram if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">Spectrogram</span><span class="p">):</span>
            <span class="c1"># try to instantiate a Spectrogram object</span>
            <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">Spectrogram</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">spectrogram</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># make a copy of the spectrogram</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># scale the spectrogram</span>
        <span class="k">if</span> <span class="n">mul</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">*=</span> <span class="n">mul</span>
        <span class="k">if</span> <span class="n">add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">add</span>
        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="c1"># cast as FilteredSpectrogram</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># save additional attributes</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">mul</span> <span class="o">=</span> <span class="n">mul</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">add</span>
        <span class="c1"># and those from the given spectrogram</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">stft</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="o">.</span><span class="n">stft</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">spectrogram</span> <span class="o">=</span> <span class="n">spectrogram</span>
        <span class="c1"># return the object</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># set default values here, also needed for views</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stft</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;stft&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;spectrogram&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mul</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;mul&#39;</span><span class="p">,</span> <span class="n">MUL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="n">ADD</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filterbank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filterbank.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">filterbank</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bin frequencies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">bin_frequencies</span>


<span class="k">class</span> <span class="nc">LogarithmicSpectrogramProcessor</span><span class="p">(</span><span class="n">Processor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logarithmic Spectrogram Processor class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    log : numpy ufunc, optional</span>
<span class="sd">        Loagrithmic scaling function to apply.</span>
<span class="sd">    mul : float, optional</span>
<span class="sd">        Multiply the magnitude spectrogram with this factor before taking the</span>
<span class="sd">        logarithm.</span>
<span class="sd">    add : float, optional</span>
<span class="sd">        Add this value before taking the logarithm of the magnitudes.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">LOG</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="n">MUL</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">ADD</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mul</span> <span class="o">=</span> <span class="n">mul</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">add</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform logarithmic scaling of a spectrogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : numpy array</span>
<span class="sd">            Data to be processed.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments passed to :class:`LogarithmicSpectrogram`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        log_spec : :class:`LogarithmicSpectrogram` instance</span>
<span class="sd">            Logarithmically scaled spectrogram.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update arguments passed to LogarithmicSpectrogram</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># instantiate a LogarithmicSpectrogram</span>
        <span class="k">return</span> <span class="n">LogarithmicSpectrogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add spectrogram scaling related arguments to an existing parser.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parser : argparse parser instance</span>
<span class="sd">            Existing argparse parser object.</span>
<span class="sd">        log : bool, optional</span>
<span class="sd">            Take the logarithm of the spectrogram.</span>
<span class="sd">        mul : float, optional</span>
<span class="sd">            Multiply the magnitude spectrogram with this factor before taking</span>
<span class="sd">            the logarithm.</span>
<span class="sd">        add : float, optional</span>
<span class="sd">            Add this value before taking the logarithm of the magnitudes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        argparse argument group</span>
<span class="sd">            Spectrogram scaling argument parser group.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Parameters are included in the group only if they are not &#39;None&#39;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># add log related options to the existing parser</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;magnitude scaling arguments&#39;</span><span class="p">)</span>
        <span class="c1"># log</span>
        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--linear&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_const&#39;</span><span class="p">,</span>
                           <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">LOG</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;linear magnitudes [default=logarithmic]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--log&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_const&#39;</span><span class="p">,</span>
                           <span class="n">const</span><span class="o">=</span><span class="n">LOG</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;logarithmic magnitudes [default=linear]&#39;</span><span class="p">)</span>
        <span class="c1"># mul</span>
        <span class="k">if</span> <span class="n">mul</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--mul&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                           <span class="n">default</span><span class="o">=</span><span class="n">mul</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;multiplier (before taking &#39;</span>
                           <span class="s1">&#39;the log) [default=</span><span class="si">%(default).1f</span><span class="s1">]&#39;</span><span class="p">)</span>
        <span class="c1"># add</span>
        <span class="k">if</span> <span class="n">add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--add&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                           <span class="n">default</span><span class="o">=</span><span class="n">add</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;value added (before taking &#39;</span>
                           <span class="s1">&#39;the log) [default=</span><span class="si">%(default).1f</span><span class="s1">]&#39;</span><span class="p">)</span>
        <span class="c1"># return the group</span>
        <span class="k">return</span> <span class="n">g</span>


<span class="c1"># logarithmic filtered spectrogram class</span>
<span class="k">class</span> <span class="nc">LogarithmicFilteredSpectrogram</span><span class="p">(</span><span class="n">LogarithmicSpectrogram</span><span class="p">,</span>
                                     <span class="n">FilteredSpectrogram</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LogarithmicFilteredSpectrogram class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrogram : :class:`FilteredSpectrogram` instance</span>
<span class="sd">        Filtered spectrogram.</span>
<span class="sd">    kwargs : dict, optional</span>
<span class="sd">        If no :class:`FilteredSpectrogram` instance was given, one is</span>
<span class="sd">        instantiated with these additional keyword arguments and</span>
<span class="sd">        logarithmically scaled afterwards, i.e. passed to</span>
<span class="sd">        :class:`LogarithmicSpectrogram`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    For the filtering and scaling parameters, please refer to</span>
<span class="sd">    :class:`FilteredSpectrogram` and :class:`LogarithmicSpectrogram`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :class:`FilteredSpectrogram`</span>
<span class="sd">    :class:`LogarithmicSpectrogram`</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Create a :class:`LogarithmicFilteredSpectrogram` from a</span>
<span class="sd">    :class:`Spectrogram` (or anything it can be instantiated from. This is</span>
<span class="sd">    mainly a convenience class which first filters the spectrogram and then</span>
<span class="sd">    scales it logarithmically.</span>

<span class="sd">    &gt;&gt;&gt; spec = LogarithmicFilteredSpectrogram(&#39;tests/data/audio/sample.wav&#39;)</span>
<span class="sd">    &gt;&gt;&gt; spec  # doctest: +NORMALIZE_WHITESPACE +ELLIPSIS</span>
<span class="sd">    LogarithmicFilteredSpectrogram([[0.82358, 0.86341, ..., 0.02295, 0.02719],</span>
<span class="sd">                                    [0.97509, 0.98658, ..., 0.03223, 0.0375 ],</span>
<span class="sd">                                    ...,</span>
<span class="sd">                                    [1.04322, 0.32637, ..., 0.02065, 0.01821],</span>
<span class="sd">                                    [0.98236, 0.89276, ..., 0.01587, 0.0144 ]],</span>
<span class="sd">                                    dtype=float32)</span>
<span class="sd">    &gt;&gt;&gt; spec.shape</span>
<span class="sd">    (281, 81)</span>
<span class="sd">    &gt;&gt;&gt; spec.filterbank  # doctest: +ELLIPSIS</span>
<span class="sd">    LogarithmicFilterbank([[...]], dtype=float32)</span>
<span class="sd">    &gt;&gt;&gt; spec.min()  # doctest: +ELLIPSIS</span>
<span class="sd">    LogarithmicFilteredSpectrogram(0.00831, dtype=float32)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=super-on-old-class</span>
    <span class="c1"># pylint: disable=super-init-not-called</span>
    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this method is for documentation purposes only</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># get the log args</span>
        <span class="n">mul</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mul&#39;</span><span class="p">,</span> <span class="n">MUL</span><span class="p">)</span>
        <span class="n">add</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="n">ADD</span><span class="p">)</span>
        <span class="c1"># instantiate a FilteredSpectrogram if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">FilteredSpectrogram</span><span class="p">):</span>
            <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">FilteredSpectrogram</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># take the logarithm</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">LogarithmicSpectrogram</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="n">mul</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">add</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># cast as LogarithmicFilteredSpectrogram</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># save additional attributes</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">mul</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mul</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">add</span>
        <span class="c1"># and those from the given spectrogram</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">stft</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="o">.</span><span class="n">stft</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">spectrogram</span> <span class="o">=</span> <span class="n">spectrogram</span>
        <span class="c1"># return the object</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filterbank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filterbank.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">filterbank</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bin frequencies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span><span class="o">.</span><span class="n">center_frequencies</span>


<span class="k">class</span> <span class="nc">LogarithmicFilteredSpectrogramProcessor</span><span class="p">(</span><span class="n">Processor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logarithmic Filtered Spectrogram Processor class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filterbank : :class:`.audio.filters.Filterbank`</span>
<span class="sd">        Filterbank used to filter a spectrogram.</span>
<span class="sd">    num_bands : int</span>
<span class="sd">        Number of bands (per octave).</span>
<span class="sd">    fmin : float, optional</span>
<span class="sd">        Minimum frequency of the filterbank [Hz].</span>
<span class="sd">    fmax : float, optional</span>
<span class="sd">        Maximum frequency of the filterbank [Hz].</span>
<span class="sd">    fref : float, optional</span>
<span class="sd">        Tuning frequency of the filterbank [Hz].</span>
<span class="sd">    norm_filters : bool, optional</span>
<span class="sd">        Normalize the filter of the filterbank to area 1.</span>
<span class="sd">    unique_filters : bool, optional</span>
<span class="sd">        Indicate if the filterbank should contain only unique filters, i.e.</span>
<span class="sd">        remove duplicate filters resulting from insufficient resolution at</span>
<span class="sd">        low frequencies.</span>
<span class="sd">    mul : float, optional</span>
<span class="sd">        Multiply the magnitude spectrogram with this factor before taking the</span>
<span class="sd">        logarithm.</span>
<span class="sd">    add : float, optional</span>
<span class="sd">        Add this value before taking the logarithm of the magnitudes.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filterbank</span><span class="o">=</span><span class="n">FILTERBANK</span><span class="p">,</span> <span class="n">num_bands</span><span class="o">=</span><span class="n">NUM_BANDS</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="n">FMIN</span><span class="p">,</span>
                 <span class="n">fmax</span><span class="o">=</span><span class="n">FMAX</span><span class="p">,</span> <span class="n">fref</span><span class="o">=</span><span class="n">A4</span><span class="p">,</span> <span class="n">norm_filters</span><span class="o">=</span><span class="n">NORM_FILTERS</span><span class="p">,</span>
                 <span class="n">unique_filters</span><span class="o">=</span><span class="n">UNIQUE_FILTERS</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="n">MUL</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">ADD</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span> <span class="o">=</span> <span class="n">filterbank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">=</span> <span class="n">num_bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmin</span> <span class="o">=</span> <span class="n">fmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">fmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fref</span> <span class="o">=</span> <span class="n">fref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_filters</span> <span class="o">=</span> <span class="n">norm_filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_filters</span> <span class="o">=</span> <span class="n">unique_filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mul</span> <span class="o">=</span> <span class="n">mul</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">add</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform filtering and logarithmic scaling of a spectrogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : numpy array</span>
<span class="sd">            Data to be processed.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments passed to</span>
<span class="sd">            :class:`LogarithmicFilteredSpectrogram`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        log_filt_spec : :class:`LogarithmicFilteredSpectrogram` instance</span>
<span class="sd">            Logarithmically scaled filtered spectrogram.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update arguments passed to LogarithmicFilteredSpectrogram</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filterbank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span><span class="p">,</span> <span class="n">num_bands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">,</span>
                    <span class="n">fmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmax</span><span class="p">,</span> <span class="n">fref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fref</span><span class="p">,</span>
                    <span class="n">norm_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_filters</span><span class="p">,</span>
                    <span class="n">unique_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_filters</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span>
                    <span class="n">add</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># instantiate a LogarithmicFilteredSpectrogram</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">LogarithmicFilteredSpectrogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># cache the filterbank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filterbank</span>
        <span class="k">return</span> <span class="n">data</span>


<span class="c1"># spectrogram difference stuff</span>
<span class="n">DIFF_RATIO</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">DIFF_FRAMES</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">DIFF_MAX_BINS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">POSITIVE_DIFFS</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_diff_frames</span><span class="p">(</span><span class="n">diff_ratio</span><span class="p">,</span> <span class="n">hop_size</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the number of `diff_frames` for the given ratio of overlap.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    diff_ratio : float</span>
<span class="sd">        Ratio of overlap of windows of two consecutive STFT frames.</span>
<span class="sd">    hop_size : int</span>
<span class="sd">        Samples between two adjacent frames.</span>
<span class="sd">    frame_size : int</span>
<span class="sd">        Size of one frames in samples.</span>
<span class="sd">    window : numpy ufunc or array</span>
<span class="sd">        Window funtion.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    diff_frames : int</span>
<span class="sd">        Number of frames to calculate the difference to.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate the number of diff frames on basis of the diff_ratio</span>
    <span class="c1"># first sample of the window with a higher magnitude than given ratio</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
        <span class="c1"># Note: if only a window function is given (default in audio.stft),</span>
        <span class="c1">#       generate a window of size `frame_size` with the given shape</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">(</span><span class="n">frame_size</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">window</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">diff_ratio</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">window</span><span class="p">))</span>
    <span class="n">diff_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sample</span>
    <span class="c1"># convert to frames, must be at least 1</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">diff_samples</span> <span class="o">/</span> <span class="n">hop_size</span><span class="p">)))</span>


<span class="k">class</span> <span class="nc">SpectrogramDifference</span><span class="p">(</span><span class="n">Spectrogram</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SpectrogramDifference class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrogram : :class:`Spectrogram` instance</span>
<span class="sd">        Spectrogram.</span>
<span class="sd">    diff_ratio : float, optional</span>
<span class="sd">        Calculate the difference to the frame at which the window used for the</span>
<span class="sd">        STFT yields this ratio of the maximum height.</span>
<span class="sd">    diff_frames : int, optional</span>
<span class="sd">        Calculate the difference to the `diff_frames`-th previous frame (if</span>
<span class="sd">        set, this overrides the value calculated from the `diff_ratio`)</span>
<span class="sd">    diff_max_bins : int, optional</span>
<span class="sd">        Apply a maximum filter with this width (in bins in frequency dimension)</span>
<span class="sd">        to the spectrogram the difference is calculated to.</span>
<span class="sd">    positive_diffs : bool, optional</span>
<span class="sd">        Keep only the positive differences, i.e. set all diff values &lt; 0 to 0.</span>
<span class="sd">    keep_dims : bool, optional</span>
<span class="sd">        Indicate if the dimensions (i.e. shape) of the spectrogram should be</span>
<span class="sd">        kept.</span>
<span class="sd">    kwargs : dict, optional</span>
<span class="sd">        If no :class:`Spectrogram` instance was given, one is instantiated with</span>
<span class="sd">        these additional keyword arguments.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The first `diff_frames` frames will have a value of 0.</span>

<span class="sd">    If `keep_dims` is &#39;True&#39; the returned difference has the same shape as the</span>
<span class="sd">    spectrogram. This is needed if the diffs should be stacked on top of it.</span>
<span class="sd">    If set to &#39;False&#39;, the length will be `diff_frames` frames shorter (mostly</span>
<span class="sd">    used by the SpectrogramDifferenceProcessor which first buffers that many</span>
<span class="sd">    frames.</span>

<span class="sd">    The SuperFlux algorithm [1]_ uses a maximum filtered spectrogram with 3</span>
<span class="sd">    `diff_max_bins` together with a 24 band logarithmic filterbank to calculate</span>
<span class="sd">    the difference spectrogram with a `diff_ratio` of 0.5.</span>

<span class="sd">    The effect of this maximum filter applied to the spectrogram is that the</span>
<span class="sd">    magnitudes are &quot;widened&quot; in frequency direction, i.e. the following</span>
<span class="sd">    difference calculation is less sensitive against frequency fluctuations.</span>
<span class="sd">    This effect is exploited to suppress false positive energy fragments</span>
<span class="sd">    originating from vibrato.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Sebastian Bck and Gerhard Widmer</span>
<span class="sd">           &quot;Maximum Filter Vibrato Suppression for Onset Detection&quot;</span>
<span class="sd">           Proceedings of the 16th International Conference on Digital Audio</span>
<span class="sd">           Effects (DAFx), 2013.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    To obtain the SuperFlux feature as described above first create a filtered</span>
<span class="sd">    and logarithmically spaced spectrogram:</span>

<span class="sd">    &gt;&gt;&gt; spec = LogarithmicFilteredSpectrogram(&#39;tests/data/audio/sample.wav&#39;, \</span>
<span class="sd">                                              num_bands=24, fps=200)</span>
<span class="sd">    &gt;&gt;&gt; spec  # doctest: +NORMALIZE_WHITESPACE +ELLIPSIS</span>
<span class="sd">    LogarithmicFilteredSpectrogram([[0.82358, 0.86341, ..., 0.02809, 0.02672],</span>
<span class="sd">                                    [0.92514, 0.93211, ..., 0.03607, 0.0317 ],</span>
<span class="sd">                                    ...,</span>
<span class="sd">                                    [1.03826, 0.767  , ..., 0.01814, 0.01138],</span>
<span class="sd">                                    [0.98236, 0.89276, ..., 0.01669, 0.00919]],</span>
<span class="sd">                                    dtype=float32)</span>
<span class="sd">    &gt;&gt;&gt; spec.shape</span>
<span class="sd">    (561, 140)</span>

<span class="sd">    Then use the temporal first order difference and apply a maximum filter</span>
<span class="sd">    with 3 bands, keeping only the positive differences (i.e. rise in energy):</span>

<span class="sd">    &gt;&gt;&gt; superflux = SpectrogramDifference(spec, diff_max_bins=3, \</span>
<span class="sd">                                          positive_diffs=True)</span>
<span class="sd">    &gt;&gt;&gt; superflux  # doctest: +NORMALIZE_WHITESPACE +ELLIPSIS</span>
<span class="sd">    SpectrogramDifference([[0.     , 0. , ...,  0. ,  0. ],</span>
<span class="sd">                           [0.     , 0. , ...,  0. ,  0. ],</span>
<span class="sd">                           ...,</span>
<span class="sd">                           [0.01941, 0. , ...,  0. ,  0. ],</span>
<span class="sd">                           [0.     , 0. , ...,  0. ,  0. ]], dtype=float32)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=super-on-old-class</span>
    <span class="c1"># pylint: disable=super-init-not-called</span>
    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="n">diff_ratio</span><span class="o">=</span><span class="n">DIFF_RATIO</span><span class="p">,</span>
                 <span class="n">diff_frames</span><span class="o">=</span><span class="n">DIFF_FRAMES</span><span class="p">,</span> <span class="n">diff_max_bins</span><span class="o">=</span><span class="n">DIFF_MAX_BINS</span><span class="p">,</span>
                 <span class="n">positive_diffs</span><span class="o">=</span><span class="n">POSITIVE_DIFFS</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this method is for documentation purposes only</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="n">diff_ratio</span><span class="o">=</span><span class="n">DIFF_RATIO</span><span class="p">,</span>
                <span class="n">diff_frames</span><span class="o">=</span><span class="n">DIFF_FRAMES</span><span class="p">,</span> <span class="n">diff_max_bins</span><span class="o">=</span><span class="n">DIFF_MAX_BINS</span><span class="p">,</span>
                <span class="n">positive_diffs</span><span class="o">=</span><span class="n">POSITIVE_DIFFS</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># instantiate a Spectrogram if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">Spectrogram</span><span class="p">):</span>
            <span class="c1"># try to instantiate a Spectrogram object</span>
            <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">Spectrogram</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># calculate the number of diff frames to use</span>
        <span class="k">if</span> <span class="n">diff_frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">diff_frames</span> <span class="o">=</span> <span class="n">_diff_frames</span><span class="p">(</span>
                <span class="n">diff_ratio</span><span class="p">,</span> <span class="n">hop_size</span><span class="o">=</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">stft</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">hop_size</span><span class="p">,</span>
                <span class="n">frame_size</span><span class="o">=</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">stft</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">frame_size</span><span class="p">,</span>
                <span class="n">window</span><span class="o">=</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">stft</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>

        <span class="c1"># apply a maximum filter to diff_spec if needed</span>
        <span class="k">if</span> <span class="n">diff_max_bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">diff_max_bins</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.ndimage.filters</span> <span class="k">import</span> <span class="n">maximum_filter</span>
            <span class="c1"># widen the spectrogram in frequency dimension</span>
            <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">diff_max_bins</span><span class="p">))</span>
            <span class="n">diff_spec</span> <span class="o">=</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff_spec</span> <span class="o">=</span> <span class="n">spectrogram</span>

        <span class="c1"># calculate the diff</span>
        <span class="k">if</span> <span class="n">keep_dims</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">)</span>
            <span class="n">diff</span><span class="p">[</span><span class="n">diff_frames</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spectrogram</span><span class="p">[</span><span class="n">diff_frames</span><span class="p">:]</span> <span class="o">-</span>
                                  <span class="n">diff_spec</span><span class="p">[:</span><span class="o">-</span><span class="n">diff_frames</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="p">[</span><span class="n">diff_frames</span><span class="p">:]</span> <span class="o">-</span> <span class="n">diff_spec</span><span class="p">[:</span><span class="o">-</span><span class="n">diff_frames</span><span class="p">]</span>

        <span class="c1"># positive differences only?</span>
        <span class="k">if</span> <span class="n">positive_diffs</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">diff</span><span class="p">)</span>

        <span class="c1"># cast as FilteredSpectrogram</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># save additional attributes</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">spectrogram</span> <span class="o">=</span> <span class="n">spectrogram</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">diff_ratio</span> <span class="o">=</span> <span class="n">diff_ratio</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">diff_frames</span> <span class="o">=</span> <span class="n">diff_frames</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">diff_max_bins</span> <span class="o">=</span> <span class="n">diff_max_bins</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">positive_diffs</span> <span class="o">=</span> <span class="n">positive_diffs</span>
        <span class="c1"># return the object</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># set default values here, also needed for views</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_ratio</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;diff_ratio&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_frames</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;diff_frames&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_max_bins</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;diff_max_bins&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive_diffs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;positive_diffs&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin_frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bin frequencies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">bin_frequencies</span>

    <span class="k">def</span> <span class="nf">positive_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Positive diff.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SpectrogramDifferenceProcessor</span><span class="p">(</span><span class="n">Processor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Difference Spectrogram Processor class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    diff_ratio : float, optional</span>
<span class="sd">        Calculate the difference to the frame at which the window used for the</span>
<span class="sd">        STFT yields this ratio of the maximum height.</span>
<span class="sd">    diff_frames : int, optional</span>
<span class="sd">        Calculate the difference to the `diff_frames`-th previous frame (if</span>
<span class="sd">        set, this overrides the value calculated from the `diff_ratio`)</span>
<span class="sd">    diff_max_bins : int, optional</span>
<span class="sd">        Apply a maximum filter with this width (in bins in frequency dimension)</span>
<span class="sd">        to the spectrogram the difference is calculated to.</span>
<span class="sd">    positive_diffs : bool, optional</span>
<span class="sd">        Keep only the positive differences, i.e. set all diff values &lt; 0 to 0.</span>
<span class="sd">    stack_diffs : numpy stacking function, optional</span>
<span class="sd">        If &#39;None&#39;, only the differences are returned. If set, the diffs are</span>
<span class="sd">        stacked with the underlying spectrogram data according to the `stack`</span>
<span class="sd">        function:</span>

<span class="sd">        - ``np.vstack``</span>
<span class="sd">          the differences and spectrogram are stacked vertically, i.e. in time</span>
<span class="sd">          direction,</span>
<span class="sd">        - ``np.hstack``</span>
<span class="sd">          the differences and spectrogram are stacked horizontally, i.e. in</span>
<span class="sd">          frequency direction,</span>
<span class="sd">        - ``np.dstack``</span>
<span class="sd">          the differences and spectrogram are stacked in depth, i.e. return</span>
<span class="sd">          them as a 3D representation with depth as the third dimension.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diff_ratio</span><span class="o">=</span><span class="n">DIFF_RATIO</span><span class="p">,</span> <span class="n">diff_frames</span><span class="o">=</span><span class="n">DIFF_FRAMES</span><span class="p">,</span>
                 <span class="n">diff_max_bins</span><span class="o">=</span><span class="n">DIFF_MAX_BINS</span><span class="p">,</span> <span class="n">positive_diffs</span><span class="o">=</span><span class="n">POSITIVE_DIFFS</span><span class="p">,</span>
                 <span class="n">stack_diffs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_ratio</span> <span class="o">=</span> <span class="n">diff_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_frames</span> <span class="o">=</span> <span class="n">diff_frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_max_bins</span> <span class="o">=</span> <span class="n">diff_max_bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive_diffs</span> <span class="o">=</span> <span class="n">positive_diffs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_diffs</span> <span class="o">=</span> <span class="n">stack_diffs</span>
        <span class="c1"># attributes needed for stateful processing</span>
        <span class="c1"># Note: do not init the buffer here, since it depends on the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># copy everything to a pickleable object</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># do not pickle attributes needed for stateful processing</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_buffer&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c1"># restore pickled instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="c1"># add non-pickled attributes needed for stateful processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a temporal difference calculation on the given data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : numpy array</span>
<span class="sd">            Data to be processed.</span>
<span class="sd">        reset : bool, optional</span>
<span class="sd">            Reset the spectrogram buffer before computing the difference.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments passed to :class:`SpectrogramDifference`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        diff : :class:`SpectrogramDifference` instance</span>
<span class="sd">            Spectrogram difference.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If `reset` is &#39;True&#39;, the first `diff_frames` differences will be 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update arguments passed to SpectrogramDifference</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">diff_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">diff_ratio</span><span class="p">,</span> <span class="n">diff_frames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">diff_frames</span><span class="p">,</span>
                    <span class="n">diff_max_bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">diff_max_bins</span><span class="p">,</span>
                    <span class="n">positive_diffs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_diffs</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># calculate the number of diff frames</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diff_frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Note: use diff_ration from args, not self.diff_ratio</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diff_frames</span> <span class="o">=</span> <span class="n">_diff_frames</span><span class="p">(</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;diff_ratio&#39;</span><span class="p">],</span> <span class="n">frame_size</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">stft</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">frame_size</span><span class="p">,</span>
                <span class="n">hop_size</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">stft</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">hop_size</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">stft</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="c1"># init buffer or shift it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reset</span><span class="p">:</span>
            <span class="c1"># put diff_frames infs before the data (will be replaced by 0s)</span>
            <span class="n">init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">diff_frames</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">init</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># use the data for the buffer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">BufferProcessor</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># shift buffer by length of data and put new data at end of buffer</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># compute difference based on this data (reduce 1st dimension)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">SpectrogramDifference</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># set all inf-diffs to 0</span>
        <span class="n">diff</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">diff</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># stack the diff and the data if needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_diffs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">diff</span>
        <span class="c1"># Note: don&#39;t use `data` directly, because it could be a str</span>
        <span class="c1">#       we ave to access diff.spectrogram (i.e. converted data)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_diffs</span><span class="p">((</span><span class="n">diff</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">diff_frames</span><span class="p">:],</span> <span class="n">diff</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the SpectrogramDifferenceProcessor.&quot;&quot;&quot;</span>
        <span class="c1"># reset cached spectrogram data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diff_ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diff_frames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">diff_max_bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">positive_diffs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add spectrogram difference related arguments to an existing parser.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parser : argparse parser instance</span>
<span class="sd">            Existing argparse parser object.</span>
<span class="sd">        diff : bool, optional</span>
<span class="sd">            Take the difference of the spectrogram.</span>
<span class="sd">        diff_ratio : float, optional</span>
<span class="sd">            Calculate the difference to the frame at which the window used for</span>
<span class="sd">            the STFT yields this ratio of the maximum height.</span>
<span class="sd">        diff_frames : int, optional</span>
<span class="sd">            Calculate the difference to the `diff_frames`-th previous frame (if</span>
<span class="sd">            set, this overrides the value calculated from the `diff_ratio`)</span>
<span class="sd">        diff_max_bins : int, optional</span>
<span class="sd">            Apply a maximum filter with this width (in bins in frequency</span>
<span class="sd">            dimension) to the spectrogram the difference is calculated to.</span>
<span class="sd">        positive_diffs : bool, optional</span>
<span class="sd">            Keep only the positive differences, i.e. set all diff values &lt; 0</span>
<span class="sd">            to 0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        argparse argument group</span>
<span class="sd">            Spectrogram difference argument parser group.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Parameters are included in the group only if they are not &#39;None&#39;.</span>

<span class="sd">        Only the `diff_frames` parameter behaves differently, it is included</span>
<span class="sd">        if either the `diff_ratio` is set or a value != &#39;None&#39; is given.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># add diff related options to the existing parser</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;spectrogram difference arguments&#39;</span><span class="p">)</span>
        <span class="c1"># diff</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no_diff&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use the spectrogram [default=differences &#39;</span>
                                <span class="s1">&#39;of the spectrogram]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">diff</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--diff&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use the differences of the spectrogram &#39;</span>
                                <span class="s1">&#39;[default=spectrogram]&#39;</span><span class="p">)</span>
        <span class="c1"># diff ratio</span>
        <span class="k">if</span> <span class="n">diff_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--diff_ratio&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                           <span class="n">default</span><span class="o">=</span><span class="n">diff_ratio</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;calculate the difference to the frame at &#39;</span>
                                <span class="s1">&#39;which the window of the STFT have this ratio &#39;</span>
                                <span class="s1">&#39;of the maximum height &#39;</span>
                                <span class="s1">&#39;[default=</span><span class="si">%(default).1f</span><span class="s1">]&#39;</span><span class="p">)</span>
        <span class="c1"># diff frames</span>
        <span class="k">if</span> <span class="n">diff_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">diff_frames</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--diff_frames&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                           <span class="n">default</span><span class="o">=</span><span class="n">diff_frames</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;calculate the difference to the N-th previous&#39;</span>
                                <span class="s1">&#39; frame (this overrides the value calculated &#39;</span>
                                <span class="s1">&#39;with `diff_ratio`) [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
        <span class="c1"># positive diffs</span>
        <span class="k">if</span> <span class="n">positive_diffs</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--all_diffs&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;positive_diffs&#39;</span><span class="p">,</span>
                           <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;keep both positive and negative diffs &#39;</span>
                                <span class="s1">&#39;[default=only the positive diffs]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">positive_diffs</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--positive_diffs&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;keep only positive diffs &#39;</span>
                                <span class="s1">&#39;[default=positive and negative diffs]&#39;</span><span class="p">)</span>
        <span class="c1"># add maximum filter related options to the existing parser</span>
        <span class="k">if</span> <span class="n">diff_max_bins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--max_bins&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                           <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;diff_max_bins&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">diff_max_bins</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;apply a maximum filter with this width (in &#39;</span>
                                <span class="s1">&#39;frequency bins) [default=</span><span class="si">%(default)d</span><span class="s1">]&#39;</span><span class="p">)</span>
        <span class="c1"># return the group</span>
        <span class="k">return</span> <span class="n">g</span>


<span class="k">class</span> <span class="nc">SuperFluxProcessor</span><span class="p">(</span><span class="n">SequentialProcessor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spectrogram processor which sets the default values suitable for the</span>
<span class="sd">    SuperFlux algorithm.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-ancestors</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.stft</span> <span class="k">import</span> <span class="n">ShortTimeFourierTransformProcessor</span>
        <span class="c1"># set the default values (can be overwritten if set)</span>
        <span class="c1"># we need an un-normalized LogarithmicFilterbank with 24 bands</span>
        <span class="n">filterbank</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;filterbank&#39;</span><span class="p">,</span> <span class="n">FILTERBANK</span><span class="p">)</span>
        <span class="n">num_bands</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;num_bands&#39;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
        <span class="n">norm_filters</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;norm_filters&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># we want max filtered diffs</span>
        <span class="n">diff_ratio</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;diff_ratio&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">diff_max_bins</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;diff_max_bins&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">positive_diffs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;positive_diffs&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># processing chain</span>
        <span class="n">stft</span> <span class="o">=</span> <span class="n">ShortTimeFourierTransformProcessor</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">SpectrogramProcessor</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">FilteredSpectrogramProcessor</span><span class="p">(</span><span class="n">filterbank</span><span class="o">=</span><span class="n">filterbank</span><span class="p">,</span>
                                            <span class="n">num_bands</span><span class="o">=</span><span class="n">num_bands</span><span class="p">,</span>
                                            <span class="n">norm_filters</span><span class="o">=</span><span class="n">norm_filters</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">LogarithmicSpectrogramProcessor</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">SpectrogramDifferenceProcessor</span><span class="p">(</span><span class="n">diff_ratio</span><span class="o">=</span><span class="n">diff_ratio</span><span class="p">,</span>
                                              <span class="n">diff_max_bins</span><span class="o">=</span><span class="n">diff_max_bins</span><span class="p">,</span>
                                              <span class="n">positive_diffs</span><span class="o">=</span><span class="n">positive_diffs</span><span class="p">,</span>
                                              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># sequentially process everything</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SuperFluxProcessor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">([</span><span class="n">stft</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">diff</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">MultiBandSpectrogram</span><span class="p">(</span><span class="n">FilteredSpectrogram</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MultiBandSpectrogram class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrogram : :class:`Spectrogram` instance</span>
<span class="sd">        Spectrogram.</span>
<span class="sd">    crossover_frequencies : list or numpy array</span>
<span class="sd">        List of crossover frequencies at which the `spectrogram` is split</span>
<span class="sd">        into multiple bands.</span>
<span class="sd">    fmin : float, optional</span>
<span class="sd">        Minimum frequency of the filterbank [Hz].</span>
<span class="sd">    fmax : float, optional</span>
<span class="sd">        Maximum frequency of the filterbank [Hz].</span>
<span class="sd">    norm_filters : bool, optional</span>
<span class="sd">        Normalize the filter bands of the filterbank to area 1.</span>
<span class="sd">    unique_filters : bool, optional</span>
<span class="sd">        Indicate if the filterbank should contain only unique filters, i.e.</span>
<span class="sd">        remove duplicate filters resulting from insufficient resolution at</span>
<span class="sd">        low frequencies.</span>
<span class="sd">    kwargs : dict, optional</span>
<span class="sd">        If no :class:`Spectrogram` instance was given, one is instantiated</span>
<span class="sd">        with these additional keyword arguments.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The MultiBandSpectrogram is implemented as a :class:`Spectrogram` which</span>
<span class="sd">    uses a :class:`.audio.filters.RectangularFilterbank` to combine multiple</span>
<span class="sd">    frequency bins.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=super-on-old-class</span>
    <span class="c1"># pylint: disable=super-init-not-called</span>
    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="n">crossover_frequencies</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="n">FMIN</span><span class="p">,</span>
                 <span class="n">fmax</span><span class="o">=</span><span class="n">FMAX</span><span class="p">,</span> <span class="n">norm_filters</span><span class="o">=</span><span class="n">NORM_FILTERS</span><span class="p">,</span>
                 <span class="n">unique_filters</span><span class="o">=</span><span class="n">UNIQUE_FILTERS</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># this method is for documentation purposes only</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="n">crossover_frequencies</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="n">FMIN</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">FMAX</span><span class="p">,</span>
                <span class="n">norm_filters</span><span class="o">=</span><span class="n">NORM_FILTERS</span><span class="p">,</span> <span class="n">unique_filters</span><span class="o">=</span><span class="n">UNIQUE_FILTERS</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.filters</span> <span class="k">import</span> <span class="n">RectangularFilterbank</span>
        <span class="c1"># instantiate a Spectrogram if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">Spectrogram</span><span class="p">):</span>
            <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">Spectrogram</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># create a rectangular filterbank</span>
        <span class="n">filterbank</span> <span class="o">=</span> <span class="n">RectangularFilterbank</span><span class="p">(</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">bin_frequencies</span><span class="p">,</span>
                                           <span class="n">crossover_frequencies</span><span class="p">,</span>
                                           <span class="n">fmin</span><span class="o">=</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span>
                                           <span class="n">norm_filters</span><span class="o">=</span><span class="n">norm_filters</span><span class="p">,</span>
                                           <span class="n">unique_filters</span><span class="o">=</span><span class="n">unique_filters</span><span class="p">)</span>
        <span class="c1"># filter the spectrogram</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">filterbank</span><span class="p">)</span>
        <span class="c1"># cast as FilteredSpectrogram</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># save additional attributes</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">spectrogram</span> <span class="o">=</span> <span class="n">spectrogram</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">filterbank</span> <span class="o">=</span> <span class="n">filterbank</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">crossover_frequencies</span> <span class="o">=</span> <span class="n">crossover_frequencies</span>
        <span class="c1"># return the object</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># set default values here, also needed for views</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;spectrogram&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;filterbank&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossover_frequencies</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;crossover_frequencies&#39;</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MultiBandSpectrogramProcessor</span><span class="p">(</span><span class="n">Processor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spectrogram processor which combines the spectrogram magnitudes into</span>
<span class="sd">    multiple bands.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    crossover_frequencies : list or numpy array</span>
<span class="sd">        List of crossover frequencies at which a spectrogram is split into</span>
<span class="sd">        the individual bands.</span>
<span class="sd">    fmin : float, optional</span>
<span class="sd">        Minimum frequency of the filterbank [Hz].</span>
<span class="sd">    fmax : float, optional</span>
<span class="sd">        Maximum frequency of the filterbank [Hz].</span>
<span class="sd">    norm_filters : bool, optional</span>
<span class="sd">        Normalize the filter bands of the filterbank to area 1.</span>
<span class="sd">    unique_filters : bool, optional</span>
<span class="sd">        Indicate if the filterbank should contain only unique filters, i.e.</span>
<span class="sd">        remove duplicate filters resulting from insufficient resolution at</span>
<span class="sd">        low frequencies.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crossover_frequencies</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="n">FMIN</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">FMAX</span><span class="p">,</span>
                 <span class="n">norm_filters</span><span class="o">=</span><span class="n">NORM_FILTERS</span><span class="p">,</span> <span class="n">unique_filters</span><span class="o">=</span><span class="n">UNIQUE_FILTERS</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossover_frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">crossover_frequencies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmin</span> <span class="o">=</span> <span class="n">fmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">fmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_filters</span> <span class="o">=</span> <span class="n">norm_filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_filters</span> <span class="o">=</span> <span class="n">unique_filters</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the a multi-band representation of the given data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : numpy array</span>
<span class="sd">            Data to be processed.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Keyword arguments passed to :class:`MultiBandSpectrogram`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        multi_band_spec : :class:`MultiBandSpectrogram` instance</span>
<span class="sd">            Spectrogram split into multiple bands.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update arguments passed to MultiBandSpectrogram</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">crossover_frequencies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crossover_frequencies</span><span class="p">,</span>
                    <span class="n">fmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmax</span><span class="p">,</span>
                    <span class="n">norm_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_filters</span><span class="p">,</span>
                    <span class="n">unique_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_filters</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># instantiate a MultiBandSpectrogram</span>
        <span class="k">return</span> <span class="n">MultiBandSpectrogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SemitoneBandpassSpectrogram</span><span class="p">(</span><span class="n">FilteredSpectrogram</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a semitone spectrogram by using a time domain filterbank of</span>
<span class="sd">    bandpass filters as described in [1]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signal : Signal</span>
<span class="sd">        Signal instance.</span>
<span class="sd">    fps : float, optional</span>
<span class="sd">        Frame rate of the spectrogram [Hz].</span>
<span class="sd">    fmin : float, optional</span>
<span class="sd">        Lowest frequency of the spectrogram [Hz].</span>
<span class="sd">    fmax : float, optional</span>
<span class="sd">        Highest frequency of the spectrogram [Hz].</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Meinard Mller,</span>
<span class="sd">           &quot;Information retrieval for music and motion&quot;, Springer, 2007.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=super-on-old-class</span>
    <span class="c1"># pylint: disable=super-init-not-called</span>
    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mf">50.</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="mf">27.5</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mf">4200.</span><span class="p">):</span>
        <span class="c1"># this method is for documentation purposes only</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mf">50.</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="mf">27.5</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mf">4200.</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">filtfilt</span>
        <span class="kn">from</span> <span class="nn">.filters</span> <span class="k">import</span> <span class="n">SemitoneBandpassFilterbank</span>
        <span class="kn">from</span> <span class="nn">.signal</span> <span class="k">import</span> <span class="n">FramedSignal</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">resample</span>
        <span class="c1"># check if we got a mono Signal</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">Signal</span><span class="p">)</span> <span class="ow">or</span> <span class="n">signal</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">num_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sample_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">)</span>
        <span class="c1"># keep a reference to the original signal</span>
        <span class="n">signal_</span> <span class="o">=</span> <span class="n">signal</span>
        <span class="c1"># determine how many frames the filtered signal will have</span>
        <span class="n">num_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="o">*</span> <span class="n">fps</span> <span class="o">/</span> <span class="n">sample_rate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># compute the energy of the frames of the bandpass filtered signal</span>
        <span class="n">filterbank</span> <span class="o">=</span> <span class="n">SemitoneBandpassFilterbank</span><span class="p">(</span><span class="n">fmin</span><span class="o">=</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">)</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filt</span><span class="p">,</span> <span class="n">band_sample_rate</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">filterbank</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span>
                                          <span class="n">filterbank</span><span class="o">.</span><span class="n">band_sample_rates</span><span class="p">):</span>
            <span class="c1"># frames should overlap 50%</span>
            <span class="n">frame_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">band_sample_rate</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">fps</span><span class="p">))</span>
            <span class="c1"># down-sample audio if needed</span>
            <span class="k">if</span> <span class="n">band_sample_rate</span> <span class="o">!=</span> <span class="n">signal</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">signal_</span><span class="p">,</span> <span class="n">band_sample_rate</span><span class="p">)</span>
            <span class="c1"># filter the signal</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">filt</span>
            <span class="n">filtered_signal</span> <span class="o">=</span> <span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
            <span class="c1"># normalise the signal if it has an integer dtype</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filtered_signal</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># compute the energy of the filtered signal</span>
            <span class="c1"># Note: 1) the energy of the signal is computed with respect to the</span>
            <span class="c1">#          reference sampling rate as in the MATLAB chroma toolbox</span>
            <span class="c1">#       2) we do not sum here, but rather after splitting the</span>
            <span class="c1">#          signal into overlapping frames to avoid doubled</span>
            <span class="c1">#          computation due to the overlapping frames</span>
            <span class="n">filtered_signal</span> <span class="o">=</span> <span class="n">filtered_signal</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">band_sample_rate</span> <span class="o">*</span> <span class="mf">22050.</span>
            <span class="c1"># split into overlapping frames</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="n">FramedSignal</span><span class="p">(</span><span class="n">filtered_signal</span><span class="p">,</span> <span class="n">frame_size</span><span class="o">=</span><span class="n">frame_size</span><span class="p">,</span>
                                  <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">band_sample_rate</span><span class="p">,</span>
                                  <span class="n">num_frames</span><span class="o">=</span><span class="n">num_frames</span><span class="p">)</span>
            <span class="c1"># finally sum the energy of all frames</span>
            <span class="n">bands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># cast as SemitoneBandpassSpectrogram</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># save additional attributes</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">filterbank</span> <span class="o">=</span> <span class="n">filterbank</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="n">fps</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># set default values here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filterbank</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;filterbank&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;fps&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Audio Tagger 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Alexander Moser.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>